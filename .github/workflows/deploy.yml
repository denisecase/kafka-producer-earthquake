name: Kafka Producer and Consumer (Limited) Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 10,14,18 * * 1-5"  # Runs at 10 AM, 2 PM, 6 PM (Mon-Fri)

jobs:
  kafka-test:
    runs-on: ubuntu-latest

    services:
      zookeeper:
        image: wurstmeister/zookeeper:latest
        ports:
          - 2181:2181

      kafka:
        image: wurstmeister/kafka:latest
        ports:
          - 9092:9092
        env:
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python3 -m venv .venv
        source .venv/bin/activate
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip install --upgrade -r requirements.txt
        python3 -m pip list  

    - name: Ensure Kafka is Fully Ready
      run: |
        echo "Waiting for Kafka to be fully ready..."
        for i in {1..20}; do
          kafka_status=$(echo dump | nc localhost 9092 || echo "failed")
          if [[ $kafka_status != "failed" ]]; then
            echo "Kafka is ready!"
            break
          fi
          echo "Waiting for Kafka... ($i/20)"
          sleep 5
        done

    - name: Set Kafka Broker Address for GitHub Actions
      run: echo "KAFKA_BROKER_ADDRESS=localhost:9092" >> $GITHUB_ENV

    - name: Create Kafka Topic Before Producer Starts
      run: |
        source .venv/bin/activate
        kafka-topics.sh --create --if-not-exists --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic earthquake-events
        echo "Kafka topic 'earthquake-events' created."

    - name: Run Kafka Producer and Consumer Concurrently
      run: |
        source .venv/bin/activate
        export PYTHONPATH="$PYTHONPATH:$(pwd)"

        # Start producer and consumer in parallel
        timeout 20m python3 producers/producer_earthquake.py & 
        timeout 20m python3 consumers/consumer_earthquake.py &

        # Wait for both processes to finish
        wait
